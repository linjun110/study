/*! backbone.nakoruru 2017-01-01 */
var Nakoruru=function(a,b,c){var d={};return b.Nakoruru=d,d.$=b.$,d.extend=b.View.extend,d}(this,Backbone,_),nako_bindEntityEvents=function(a,b,c){_.each(b,function(b,c){this.listenTo(a,c,this[b],this)},c)},nako_unbindEntityEvents=function(a){a.off()};!function(a){"use strict";function b(a,b,c,d){var e=d.split(/\s+/);_.each(e,function(d){var e=a[d];if(!e)throw new Error('Method "'+d+'" was configured as an event handler, but does not exist.');a.listenTo(b,c,e)})}function c(a,b,c,d){a.listenTo(b,c,d)}function d(a,b,c,d){var e=d.split(/\s+/);_.each(e,function(d){var e=a[d];a.stopListening(b,c,e)})}function e(a,b,c,d){a.stopListening(b,c,d)}function f(b,c,d,e,f){if(c&&d){if(!_.isObject(d))throw new Error({message:"Bindings must be an object or function.",url:"nakoruru.functions.html#marionettebindentityevents"});d=a._getValue(d,b),_.each(d,function(a,d){_.isFunction(a)?e(b,c,d,a):f(b,c,d,a)})}}a.bindEntityEvents=function(a,d,e){f(a,d,e,c,b)},a.unbindEntityEvents=function(a,b,c){f(a,b,c,e,d)},a.proxyBindEntityEvents=function(b,c){return a.bindEntityEvents(this,b,c)},a.proxyUnbindEntityEvents=function(b,c){return a.unbindEntityEvents(this,b,c)}}(Nakoruru),Nakoruru.Object=function(a){this.options=_.extend({},_.result(this,"options"),a),this.initialize.apply(this,arguments)},Nakoruru.Object.extend=Nakoruru.extend,_.extend(Nakoruru.Object.prototype,Backbone.Events,{initialize:function(){},destroy:function(){return this.triggerMethod("before:destroy"),this.triggerMethod("destroy"),this.stopListening(),this},triggerMethod:Nakoruru.triggerMethod,mergeOptions:Nakoruru.mergeOptions,getOption:Nakoruru.proxyGetOption,bindEntityEvents:Nakoruru.proxyBindEntityEvents,unbindEntityEvents:Nakoruru.proxyUnbindEntityEvents}),Nakoruru.Model=Backbone.Model.extend({initialize:function(){this.parse()},parse:function(){this.subModel=this.subModel||{},_.each(this.attributes,function(a,b){if(!_.isUndefined(this.subModel[b])){var c=this.subModel[b].type||(_.isArray(a)?Backbone.Collection:Backbone.Model),d=this.subModel[b].events||{},e=new c(a);e.modelParent=this,this.set(b,e),nako_bindEntityEvents(e,d,this)}},this)},_clonePrimaryAttrs:function(){var a={};return _.each(this.attributes,function(b,c){(_.isString(b)||_.isNumber(b)||_.isBoolean(b))&&(a[c]=b)}),a},_set:function(a,b){var c=this._clonePrimaryAttrs();_.isUndefined(a)||_.isUndefined(b)||(c[a]=b),c=this.recalc(c),this.set(c)},refresh:function(){this._set()},asyncRefresh:function(){var a=this;setTimeout(function(){a.refresh()})},recalc:function(a){return a}}),Nakoruru.Collection=Backbone.Collection.extend({initialize:function(){this.setUpListening()},setUpListening:function(){var a=this;setTimeout(function(){_.each(a.models,function(a){this.listenTo(a,"change",function(){this.trigger("update")},this)},a)})},addChild:function(){var a=this.model||Backbone.Model,b=new a;this.add(b)}}),Nakoruru.Region=Nakoruru.Object.extend({constructor:function(a){a=a||{},_.extend(this,a),this.$el=this.owner.$el.find(this.selector)},show:function(a){a._parentView=this.owner,a._parentRegion=this,a.render(),this._attachHtml(a),a.trigger("show")},_attachHtml:function(a){this.$el.empty(),this.$el.append(a.$el)}}),Nakoruru.View=Backbone.View.extend({constructor:function(a){a=a||{},_.extend(this,a),this.views={},a.isRootView?this.el=Nakoruru.$(document):this.$el=Nakoruru.$(document.createDocumentFragment()),Backbone.View.call(this,a),this.on("show",this._onShow),_.isUndefined(this.model)||this.model instanceof Backbone.Model?this.modelEvents&&nako_bindEntityEvents(this.model,this.modelEvents,this):this.model instanceof Backbone.Collection&&this.collectionEvents&&nako_bindEntityEvents(this.model,this.collectionEvents,this),a.isRootView&&(this.render(),this.trigger("show"))},_onShow:function(){this.onShow&&this.onShow()},_initializeRegions:function(){this._regions=this._regions||{},_.each(this.regions,function(a,b){this._regions[b]=new Nakoruru.Region({owner:this,selector:a})},this)},getRegion:function(a){return this._regions[a]},render:function(){_.isUndefined(this.model)||this.model instanceof Backbone.Model?this._renderModel():this.model instanceof Backbone.Collection&&this._renderCollection()},_renderCollection:function(){return _.each(this._childViews,function(a){a.remove()},this),this._childViews=this._childViews||[],this.childView&&_.each(this.model.models,function(a){var b=new this.childView({model:a});b.render(),this.$el.append(b.$el),this._childViews.push(b),b.trigger("show")},this),this},_renderModel:function(){return this.undelegateEvents(),this.isRootView||(this.el=this.template?this.template(this.model?this.model.toJSON():{}):"",this.$el.empty(),this.$el.append(this.el)),this._initializeRegions(),this.delegateEvents(),this}});